<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nylix Wallet Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body { font-family: 'Tajawal', sans-serif; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slideUp { animation: slideUp 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[300] bg-white flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-black text-indigo-600">Nylix جاري التحميل...</p>
    </div>

    <!-- Processing Overlay -->
    <div id="processing-overlay" class="fixed inset-0 z-[250] bg-white/70 backdrop-blur-sm hidden flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
        <p id="processing-text" class="mt-4 font-black text-emerald-600">جاري المعالجة بأمان...</p>
    </div>

    <!-- Auth Section -->
    <div id="auth-section" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl p-10 border border-slate-100 animate-slideUp">
            <div class="text-center mb-10">
                <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i data-lucide="wallet" class="text-white w-10 h-10"></i>
                </div>
                <h1 class="text-4xl font-black text-slate-800">Nylix</h1>
                <p class="text-slate-400 font-bold mt-2 text-sm">نظام مالي محمي بالكامل</p>
            </div>
            <div class="space-y-4">
                <input id="auth-email" type="email" placeholder="البريد الإلكتروني" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition border-none">
                <input id="auth-password" type="password" placeholder="كلمة المرور" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition border-none">
                <button onclick="handleAuth()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg hover:bg-indigo-700 active:scale-95 transition">دخول / تسجيل جديد</button>
            </div>
        </div>
    </div>

    <!-- PIN Modal (The Heart of the Fix) -->
    <div id="pin-modal" class="fixed inset-0 z-[200] bg-white hidden flex flex-col items-center justify-center p-8">
        <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="lock"></i></div>
        <h2 id="pin-title" class="text-2xl font-black mb-2 text-center">أدخل رمز PIN</h2>
        <div id="pin-dots" class="flex gap-3 mb-10">
            <div class="w-4 h-4 rounded-full bg-slate-200"></div>
            <div class="w-4 h-4 rounded-full bg-slate-200"></div>
            <div class="w-4 h-4 rounded-full bg-slate-200"></div>
            <div class="w-4 h-4 rounded-full bg-slate-200"></div>
            <div class="w-4 h-4 rounded-full bg-slate-200"></div>
            <div class="w-4 h-4 rounded-full bg-slate-200"></div>
        </div>
        <div class="grid grid-cols-3 gap-5 w-full max-w-xs">
            <button onclick="pressPin('1')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">1</button>
            <button onclick="pressPin('2')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">2</button>
            <button onclick="pressPin('3')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">3</button>
            <button onclick="pressPin('4')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">4</button>
            <button onclick="pressPin('5')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">5</button>
            <button onclick="pressPin('6')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">6</button>
            <button onclick="pressPin('7')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">7</button>
            <button onclick="pressPin('8')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">8</button>
            <button onclick="pressPin('9')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">9</button>
            <div class="h-16"></div>
            <button onclick="pressPin('0')" class="h-16 rounded-2xl bg-slate-50 active:bg-indigo-100 text-2xl font-black">0</button>
            <button onclick="deletePin()" class="h-16 rounded-2xl bg-rose-50 text-rose-500 flex items-center justify-center"><i data-lucide="delete"></i></button>
        </div>
        <div class="mt-10 flex gap-4 w-full max-w-xs">
            <button id="pin-cancel-btn" onclick="closePinModal()" class="flex-1 py-4 bg-slate-100 rounded-2xl font-black">إلغاء</button>
            <button onclick="confirmPinAction()" class="flex-2 py-4 bg-indigo-600 text-white rounded-2xl font-black flex-grow">تأكيد</button>
        </div>
        <button id="forgot-pin-btn" onclick="showResetPinWithPassword()" class="mt-6 text-indigo-600 font-bold text-sm hidden">نسيت رمز PIN؟</button>
    </div>

    <!-- Password Verification Modal -->
    <div id="reset-pin-modal" class="fixed inset-0 z-[210] bg-white hidden flex flex-col items-center justify-center p-8">
        <div class="w-full max-w-xs space-y-6 animate-slideUp text-center">
            <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto"><i data-lucide="shield-alert"></i></div>
            <h2 class="text-2xl font-black">إعادة تعيين PIN</h2>
            <p class="text-slate-500 text-sm">أدخل كلمة مرور حسابك (المحفظة) لتتمكن من تغيير رمز PIN</p>
            <input id="reset-account-password" type="password" placeholder="كلمة مرور الحساب" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-600 border-none">
            <div class="flex gap-4">
                <button onclick="hideResetPinWithPassword()" class="flex-1 py-4 bg-slate-100 rounded-2xl font-black">إلغاء</button>
                <button onclick="verifyPasswordAndResetPin()" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black">تحقق</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-content" class="hidden max-w-md mx-auto min-h-screen bg-white shadow-2xl relative pb-24 overflow-hidden">
        
        <!-- View: Home -->
        <div id="view-home" class="p-6 space-y-8 animate-slideUp">
            <header class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white font-black text-xl">N</div>
                    <div>
                        <h2 id="user-name" class="text-lg font-black text-slate-800">...</h2>
                        <div onclick="copyId()" class="flex items-center gap-1.5 text-indigo-600 text-xs font-black cursor-pointer bg-indigo-50 px-2 py-0.5 rounded-lg">
                            ID: <span id="display-nylix-id">...</span> <i data-lucide="copy" class="w-3 h-3"></i>
                        </div>
                    </div>
                </div>
                <button onclick="signOutUser()" class="p-2.5 bg-rose-50 text-rose-500 rounded-2xl"><i data-lucide="log-out"></i></button>
            </header>

            <div class="bg-indigo-600 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-indigo-100 text-[10px] font-black uppercase tracking-widest">الرصيد الكلي</span>
                        <button onclick="toggleBalance()" class="bg-white/10 p-2 rounded-xl"><i id="eye-icon" data-lucide="eye"></i></button>
                    </div>
                    <h1 id="balance-text" class="text-4xl font-black mb-10">0.00 <span class="text-lg font-medium opacity-70">ج.م</span></h1>
                    <div class="flex gap-4">
                        <button onclick="switchTab('send')" class="flex-1 bg-white text-indigo-600 py-4 rounded-2xl font-black shadow-lg hover:bg-slate-50 transition">إرسال</button>
                        <button onclick="switchTab('withdraw')" class="flex-1 bg-indigo-500 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-indigo-400 transition">سحب</button>
                    </div>
                </div>
            </div>

            <!-- Admin Area -->
            <div id="admin-panel" class="hidden bg-amber-50 p-6 rounded-3xl border border-amber-200">
                <h3 class="text-amber-800 font-black text-sm mb-4 flex items-center gap-2"><i data-lucide="shield-check"></i> شحن الرصيد (للمدير)</h3>
                <div class="space-y-3">
                    <input id="admin-email" type="email" placeholder="بريد العميل" class="w-full p-3 rounded-xl bg-white text-sm outline-none border border-amber-100">
                    <input id="admin-amount" type="number" placeholder="المبلغ" class="w-full p-3 rounded-xl bg-white text-sm outline-none border border-amber-100">
                    <button onclick="askPin(() => adminAddBalance())" class="w-full py-3 bg-amber-600 text-white rounded-xl font-black">تأكيد الشحن</button>
                </div>
            </div>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-slate-800 font-black text-lg">العمليات الأخيرة</h3>
                    <i data-lucide="history" class="text-slate-400 w-5 h-5"></i>
                </div>
                <div id="transactions-list" class="space-y-3">
                    <div class="flex flex-col items-center py-10 opacity-30">
                        <i data-lucide="inbox" class="w-12 h-12 mb-2"></i>
                        <p class="text-sm">لا توجد عمليات</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- View: Send -->
        <div id="view-send" class="hidden p-6 space-y-6 animate-slideUp">
            <header class="flex items-center gap-4">
                <button onclick="switchTab('home')" class="p-2 bg-slate-100 rounded-xl"><i data-lucide="arrow-right"></i></button>
                <h2 class="text-xl font-black">تحويل أموال</h2>
            </header>
            <div class="space-y-4">
                <div class="bg-slate-50 p-6 rounded-3xl text-center border border-slate-100">
                    <label class="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest">المبلغ المراد تحويله</label>
                    <input id="send-amount" type="number" placeholder="0.00" class="w-full text-5xl font-black bg-transparent outline-none text-indigo-600 text-center">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-black text-slate-500 mr-2">كود المحفظة (ID)</label>
                    <input id="send-target" type="text" placeholder="NX-XXXX" class="w-full p-5 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-600 font-black text-center text-xl uppercase tracking-widest">
                </div>
                <button onclick="askPin(() => processTransfer())" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg text-lg">تأكيد عملية التحويل</button>
                <p class="text-[10px] text-center text-slate-400 font-bold">رسوم التحويل: 1.00 ج.م ثابتة</p>
            </div>
        </div>

        <!-- View: Withdraw -->
        <div id="view-withdraw" class="hidden p-6 space-y-6 animate-slideUp">
            <header class="flex items-center gap-4">
                <button onclick="switchTab('home')" class="p-2 bg-slate-100 rounded-xl"><i data-lucide="arrow-right"></i></button>
                <h2 class="text-xl font-black">سحب كاش (فودافون كاش)</h2>
            </header>
            <div class="space-y-4">
                <div class="bg-rose-50 p-6 rounded-3xl border border-rose-100 text-center">
                    <label class="text-[10px] font-black text-rose-400 block mb-2 uppercase tracking-widest">مبلغ السحب</label>
                    <input id="withdraw-amount" type="number" placeholder="0" class="w-full text-5xl font-black bg-transparent outline-none text-rose-600 text-center">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-black text-slate-500 mr-2">رقم الهاتف المستلم</label>
                    <input id="withdraw-phone" type="text" placeholder="01xxxxxxxxx" class="w-full p-5 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-rose-500 font-bold text-center text-xl">
                </div>
                <button onclick="askPin(() => processWithdraw())" class="w-full py-5 bg-rose-600 text-white rounded-2xl font-black shadow-lg">إرسال طلب السحب</button>
                <div class="p-4 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                    <p class="text-[11px] text-slate-500 leading-relaxed text-center font-bold">سيتم خصم المبلغ من رصيدك فوراً وتحويلك لخدمة العملاء لتأكيد عملية التحويل لرقمك.</p>
                </div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <nav class="absolute bottom-0 w-full bg-white/80 backdrop-blur-md border-t border-slate-100 px-10 py-5 flex justify-between items-center z-[90]">
            <button onclick="switchTab('home')" class="nav-icon text-indigo-600" data-tab="home"><i data-lucide="home" size="28"></i></button>
            <button onclick="switchTab('send')" class="nav-icon text-slate-300" data-tab="send"><i data-lucide="send" size="28" style="transform: rotate(180deg)"></i></button>
            <button onclick="switchTab('withdraw')" class="nav-icon text-slate-300" data-tab="withdraw"><i data-lucide="arrow-down-circle" size="28"></i></button>
        </nav>
    </div>

    <!-- Notifications (Toast) -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[500] px-6 py-3 rounded-2xl shadow-2xl hidden flex items-center gap-3 transition-all duration-300">
        <span id="toast-message" class="font-bold"></span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCWyQfMmzp41jTYV4GXFViV2wMMTIiP8XU",
            authDomain: "wallet-52a17.firebaseapp.com",
            projectId: "wallet-52a17",
            storageBucket: "wallet-52a17.appspot.com",
            messagingSenderId: "440517088889",
            appId: "1:440517088889:web:a862ab37106851c66066a8",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const ADMIN_EMAIL = "ahmedfouad01278837444@gmail.com";
        const SUPPORT_WHATSAPP = "01012265953";

        let currentUserData = null;
        let activePinAction = null;
        let pinBuffer = "";
        let isSettingPinMode = false;
        let balanceVisible = true;

        // Monitoring Auth State
        auth.onAuthStateChanged(async user => {
            document.getElementById('loading-screen').classList.add('hidden');
            if (user) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-name').innerText = user.email.split('@')[0];
                if(user.email === ADMIN_EMAIL) document.getElementById('admin-panel').classList.remove('hidden');
                
                listenToUserData(user.uid);
                listenToTransactions(user.uid);
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
            lucide.createIcons();
        });

        function listenToUserData(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if (doc.exists) {
                    currentUserData = doc.data();
                    updateUI();
                    
                    // Force PIN setup if missing
                    if (!currentUserData.pin && !isSettingPinMode) {
                        isSettingPinMode = true;
                        openPinModal("إعداد رمز PIN جديد لمحفظتك");
                    } else if (currentUserData.pin) {
                        document.getElementById('forgot-pin-btn').classList.remove('hidden');
                    }
                } else {
                    const newId = 'NX-' + Math.floor(1000 + Math.random() * 9000);
                    db.collection('users').doc(uid).set({
                        email: auth.currentUser.email,
                        balance: 0,
                        nylixId: newId,
                        uid: uid,
                        pin: ""
                    });
                }
            }, err => showToast("خطأ في جلب البيانات: " + err.message, "error"));
        }

        function listenToTransactions(uid) {
            db.collection('transactions')
              .where('participants', 'array-contains', uid)
              .orderBy('timestamp', 'desc')
              .limit(8)
              .onSnapshot(snap => {
                  const list = document.getElementById('transactions-list');
                  if(snap.empty) return;
                  list.innerHTML = snap.docs.map(d => {
                      const tx = d.data();
                      const isMinus = tx.type !== 'transfer' || tx.participants[0] === uid;
                      return `
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-xl ${isMinus ? 'bg-rose-100 text-rose-600' : 'bg-emerald-100 text-emerald-600'}">
                                    <i data-lucide="${isMinus ? 'arrow-up-right' : 'arrow-down-left'}" class="w-4 h-4"></i>
                                </div>
                                <div><p class="text-[11px] font-black text-slate-800">${tx.details}</p></div>
                            </div>
                            <span class="font-black text-sm ${isMinus ? 'text-rose-600' : 'text-emerald-600'}">${isMinus ? '-' : '+'}${tx.amount} ج.م</span>
                        </div>`;
                  }).join('');
                  lucide.createIcons();
              }, err => console.error("Transactions error:", err));
        }

        // --- Core Business Logic ---

        async function processTransfer() {
            const amount = parseFloat(document.getElementById('send-amount').value);
            const targetId = document.getElementById('send-target').value.toUpperCase();
            if (isNaN(amount) || amount <= 0) return showToast("أدخل مبلغاً صحيحاً", "error");
            
            toggleProcessing(true, "جاري تحويل الأموال...");
            try {
                const q = await db.collection('users').where('nylixId', '==', targetId).get();
                if (q.empty) throw new Error("كود المحفظة المستهدفة غير صحيح");
                
                const receiverId = q.docs[0].id;
                if(receiverId === auth.currentUser.uid) throw new Error("لا يمكنك التحويل لنفسك");

                const receiverRef = db.collection('users').doc(receiverId);
                const senderRef = db.collection('users').doc(auth.currentUser.uid);

                await db.runTransaction(async (transaction) => {
                    const s = await transaction.get(senderRef);
                    const totalCost = amount + 1; // 1 EGP Fee
                    if (s.data().balance < totalCost) throw new Error("رصيدك لا يكفي للمبلغ + رسوم التحويل");
                    
                    transaction.update(senderRef, { balance: Number((s.data().balance - totalCost).toFixed(2)) });
                    transaction.update(receiverRef, { balance: firebase.firestore.FieldValue.increment(amount) });
                });

                await db.collection('transactions').add({
                    type: 'transfer', amount, details: `تحويل إلى ${targetId}`,
                    participants: [auth.currentUser.uid, receiverId],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast("تم التحويل بنجاح");
                document.getElementById('send-amount').value = "";
                document.getElementById('send-target').value = "";
                switchTab('home');
            } catch (err) { showToast(err.message, "error"); }
            toggleProcessing(false);
        }

        async function processWithdraw() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const phone = document.getElementById('withdraw-phone').value;
            if (isNaN(amount) || amount <= 0 || phone.length < 11) return showToast("بيانات السحب غير مكتملة", "error");

            toggleProcessing(true, "جاري معالجة طلب السحب...");
            try {
                const senderRef = db.collection('users').doc(auth.currentUser.uid);
                await db.runTransaction(async (t) => {
                    const s = await t.get(senderRef);
                    if (s.data().balance < amount) throw new Error("رصيدك غير كافٍ لهذا المبلغ");
                    t.update(senderRef, { balance: Number((s.data().balance - amount).toFixed(2)) });
                });
                await db.collection('transactions').add({
                    type: 'withdraw', amount, details: `سحب لرقم ${phone}`,
                    participants: [auth.currentUser.uid],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("تم خصم المبلغ، جاري توجيهك للواتساب");
                setTimeout(() => {
                    window.open(`https://wa.me/${SUPPORT_WHATSAPP}?text=طلب سحب نايليكس بقيمة ${amount} جنيه لرقم المحفظة: ${phone}`, '_blank');
                    switchTab('home');
                    document.getElementById('withdraw-amount').value = "";
                    document.getElementById('withdraw-phone').value = "";
                }, 1500);
            } catch (err) { showToast(err.message, "error"); }
            toggleProcessing(false);
        }

        async function adminAddBalance() {
            const email = document.getElementById('admin-email').value;
            const amount = parseFloat(document.getElementById('admin-amount').value);
            if(!email || isNaN(amount)) return showToast("أكمل بيانات الشحن", "error");

            toggleProcessing(true, "جاري شحن الرصيد...");
            try {
                const q = await db.collection('users').where('email', '==', email).get();
                if(q.empty) throw new Error("المستخدم غير موجود");

                await db.collection('users').doc(q.docs[0].id).update({ 
                    balance: firebase.firestore.FieldValue.increment(amount) 
                });
                showToast("تم شحن الحساب بنجاح");
                document.getElementById('admin-email').value = "";
                document.getElementById('admin-amount').value = "";
            } catch (err) { showToast(err.message, "error"); }
            toggleProcessing(false);
        }

        // --- PIN Logic (The Fix) ---

        function pressPin(n) {
            if(pinBuffer.length < 6) {
                pinBuffer += n;
                renderPinDots();
            }
        }

        function deletePin() {
            pinBuffer = pinBuffer.slice(0, -1);
            renderPinDots();
        }

        function renderPinDots() {
            const dots = document.getElementById('pin-dots').children;
            for(let i=0; i<6; i++) {
                dots[i].className = `w-4 h-4 rounded-full transition-all duration-200 ${pinBuffer.length > i ? 'bg-indigo-600 scale-125 shadow-sm' : 'bg-slate-200'}`;
            }
        }

        function askPin(action) {
            activePinAction = action;
            isSettingPinMode = false; 
            openPinModal("تأكيد العملية برمز PIN");
        }

        function openPinModal(title) {
            pinBuffer = "";
            document.getElementById('pin-title').innerText = title;
            document.getElementById('pin-modal').classList.remove('hidden');
            // Hide cancel if mandatory setup
            const isMandatory = (isSettingPinMode && (!currentUserData || !currentUserData.pin));
            document.getElementById('pin-cancel-btn').style.display = isMandatory ? "none" : "block";
            renderPinDots();
        }

        function closePinModal() {
            const isMandatory = (isSettingPinMode && (!currentUserData || !currentUserData.pin));
            if (isMandatory) return; 
            document.getElementById('pin-modal').classList.add('hidden');
            pinBuffer = "";
        }

        async function confirmPinAction() {
            if(pinBuffer.length < 6) return showToast("يرجى إدخال 6 أرقام", "error");

            if(isSettingPinMode) {
                // First time setup or Reset mode
                toggleProcessing(true, "جاري حفظ الرمز...");
                try {
                    const userRef = db.collection('users').doc(auth.currentUser.uid);
                    // Critical Fix: Explicitly ensuring pin is stored as string
                    await userRef.set({ pin: pinBuffer.toString() }, { merge: true });
                    
                    isSettingPinMode = false;
                    showToast("تم تفعيل الرمز بنجاح");
                    closePinModal();
                } catch (e) {
                    console.error("Save PIN Error:", e);
                    showToast("خطأ في الحفظ: " + e.message, "error");
                } finally {
                    toggleProcessing(false);
                }
            } else {
                // Verification mode for transactions
                if(pinBuffer.toString() === currentUserData.pin.toString()) {
                    const action = activePinAction;
                    closePinModal();
                    if(action) action();
                } else {
                    showToast("رمز PIN غير صحيح", "error");
                    pinBuffer = "";
                    renderPinDots();
                }
            }
        }

        // --- Security: PIN Reset via Password ---

        function showResetPinWithPassword() {
            document.getElementById('reset-pin-modal').classList.remove('hidden');
        }

        function hideResetPinWithPassword() {
            document.getElementById('reset-pin-modal').classList.add('hidden');
            document.getElementById('reset-account-password').value = "";
        }

        async function verifyPasswordAndResetPin() {
            const password = document.getElementById('reset-account-password').value;
            if(!password) return showToast("أدخل كلمة المرور للمتابعة", "error");

            toggleProcessing(true, "جاري التحقق...");
            try {
                // Re-authenticate user to prove ownership
                const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, password);
                await auth.currentUser.reauthenticateWithCredential(credential);
                
                hideResetPinWithPassword();
                isSettingPinMode = true;
                openPinModal("أدخل رمز PIN الجديد");
                showToast("تم التحقق بنجاح، عين رمزاً جديداً");
            } catch (err) {
                showToast("كلمة مرور الحساب غير صحيحة", "error");
            }
            toggleProcessing(false);
        }

        // --- UI Utilities ---

        function updateUI() {
            if(!currentUserData) return;
            document.getElementById('display-nylix-id').innerText = currentUserData.nylixId;
            const bal = balanceVisible ? currentUserData.balance.toFixed(2) : "••••";
            document.getElementById('balance-text').innerHTML = `${bal} <span class="text-lg font-medium opacity-70">ج.م</span>`;
        }

        function switchTab(tabId) {
            ['home', 'send', 'withdraw'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-icon').forEach(n => {
                n.classList.replace('text-indigo-600', 'text-slate-300');
                if(n.dataset.tab === tabId) n.classList.replace('text-slate-300', 'text-indigo-600');
            });
            lucide.createIcons();
        }

        function toggleBalance() {
            balanceVisible = !balanceVisible;
            updateUI();
            const icon = document.getElementById('eye-icon');
            icon.setAttribute('data-lucide', balanceVisible ? 'eye' : 'eye-off');
            lucide.createIcons();
        }

        function toggleProcessing(show, text = "جاري المعالجة...") {
            document.getElementById('processing-text').innerText = text;
            document.getElementById('processing-overlay').classList.toggle('hidden', !show);
        }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.className = `fixed top-6 left-1/2 -translate-x-1/2 z-[500] px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-slideUp ${type === 'success' ? 'bg-indigo-600 text-white' : 'bg-rose-600 text-white'}`;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            if(!email || !pass) return showToast("يرجى ملء كافة الحقول", "error");
            
            toggleProcessing(true, "جاري الدخول...");
            try { 
                await auth.signInWithEmailAndPassword(email, pass); 
            } catch { 
                try {
                    await auth.createUserWithEmailAndPassword(email, pass);
                } catch(err) { showToast("خطأ: " + err.message, "error"); }
            }
            toggleProcessing(false);
        }

        function copyId() {
            const el = document.createElement('textarea');
            el.value = currentUserData.nylixId;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("تم نسخ الكود ID");
        }

        function signOutUser() { auth.signOut(); }

    </script>
</body>
</html>

